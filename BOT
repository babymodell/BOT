const {
  Client,
  GatewayIntentBits,
  Partials,
  REST,
  Routes,
  SlashCommandBuilder,
  PermissionFlagsBits,
  ActionRowBuilder,
  ButtonBuilder,
  ButtonStyle,
  ModalBuilder,
  TextInputBuilder,
  TextInputStyle,
  ChannelType,
  EmbedBuilder,
  PermissionsBitField,
} = require("discord.js");

function requiredEnv(name) {
  const v = process.env[name];
  if (!v) throw new Error(`Missing environment variable: ${name}`);
  return v;
}

const TOKEN = requiredEnv("TOKEN");
const CLIENT_ID = requiredEnv("CLIENT_ID");
const GUILD_ID = requiredEnv("GUILD_ID");
const PANEL_CHANNEL_ID = requiredEnv("PANEL_CHANNEL_ID");
const TICKET_CATEGORY_ID = requiredEnv("TICKET_CATEGORY_ID");
const STAFF_ROLE_ID = requiredEnv("STAFF_ROLE_ID");

const client = new Client({
  intents: [GatewayIntentBits.Guilds],
  partials: [Partials.Channel],
});

const PANEL_BUTTON_ID = "open_create_channel_modal";
const MODAL_ID = "create_channel_modal";

async function registerCommands() {
  const commands = [
    new SlashCommandBuilder()
      .setName("panel")
      .setDescription("Postet das Channel-Erstell-Panel in den Panel-Channel.")
      .setDefaultMemberPermissions(PermissionFlagsBits.Administrator)
      .toJSON(),
  ];

  const rest = new REST({ version: "10" }).setToken(TOKEN);
  await rest.put(Routes.applicationGuildCommands(CLIENT_ID, GUILD_ID), { body: commands });
  console.log("‚úÖ Slash Commands registriert.");
}

client.once("ready", async () => {
  console.log(`‚úÖ Eingeloggt als ${client.user.tag}`);
  await registerCommands();
});

client.on("interactionCreate", async (interaction) => {
  try {
    // /panel
    if (interaction.isChatInputCommand() && interaction.commandName === "panel") {
      const panelChannel = await client.channels.fetch(PANEL_CHANNEL_ID).catch(() => null);
      if (!panelChannel) {
        return interaction.reply({ content: "‚ùå PANEL_CHANNEL_ID ist falsch / Channel nicht gefunden.", ephemeral: true });
      }

      const embed = new EmbedBuilder()
        .setTitle("üìå Channel erstellen")
        .setDescription("Klicke auf den Button und f√ºlle das Formular aus.\nEs wird automatisch ein privater Channel erstellt.")
        .setFooter({ text: "Bitte keine Fake-Daten. Datenschutz beachten." });

      const row = new ActionRowBuilder().addComponents(
        new ButtonBuilder()
          .setCustomId(PANEL_BUTTON_ID)
          .setLabel("‚ûï Channel erstellen")
          .setStyle(ButtonStyle.Primary)
      );

      await panelChannel.send({ embeds: [embed], components: [row] });
      return interaction.reply({ content: "‚úÖ Panel wurde gepostet.", ephemeral: true });
    }

    // Button -> Modal
    if (interaction.isButton() && interaction.customId === PANEL_BUTTON_ID) {
      // Discord erlaubt max. 5 Inputs pro Modal -> Bilder nicht im Modal, sondern im Ticket-Channel posten
      const modal = new ModalBuilder().setCustomId(MODAL_ID).setTitle("Channel-Erstellung");

      const channelName = new TextInputBuilder()
        .setCustomId("channel_name")
        .setLabel("Channel-Name (z.B. ticket-max)")
        .setStyle(TextInputStyle.Short)
        .setRequired(true)
        .setMaxLength(50);

      const discordUserId = new TextInputBuilder()
        .setCustomId("discord_user_id")
        .setLabel("Discord User ID (z.B. 123...)")
        .setStyle(TextInputStyle.Short)
        .setRequired(true)
        .setMaxLength(30);

      const phone = new TextInputBuilder()
        .setCustomId("phone")
        .setLabel("Telefonnummer")
        .setStyle(TextInputStyle.Short)
        .setRequired(false)
        .setMaxLength(30);

      const email = new TextInputBuilder()
        .setCustomId("email")
        .setLabel("E-Mail")
        .setStyle(TextInputStyle.Short)
        .setRequired(false)
        .setMaxLength(80);

      const nameIngame = new TextInputBuilder()
        .setCustomId("name_ingame")
        .setLabel("Name | Ingame Name | Ingame ID")
        .setPlaceholder("Max Mustermann | Max#123 | 9999")
        .setStyle(TextInputStyle.Short)
        .setRequired(false)
        .setMaxLength(120);

      modal.addComponents(
        new ActionRowBuilder().addComponents(channelName),
        new ActionRowBuilder().addComponents(discordUserId),
        new ActionRowBuilder().addComponents(phone),
        new ActionRowBuilder().addComponents(email),
        new ActionRowBuilder().addComponents(nameIngame)
      );

      await interaction.showModal(modal);
      return;
    }

    // Modal submit -> Channel erstellen
    if (interaction.isModalSubmit() && interaction.customId === MODAL_ID) {
      const rawChannelName = interaction.fields.getTextInputValue("channel_name").trim();
      const userId = interaction.fields.getTextInputValue("discord_user_id").trim();
      const phone = interaction.fields.getTextInputValue("phone")?.trim() || "‚Äî";
      const email = interaction.fields.getTextInputValue("email")?.trim() || "‚Äî";
      const nameIngame = interaction.fields.getTextInputValue("name_ingame")?.trim() || "‚Äî";

      const safeName = rawChannelName
        .toLowerCase()
        .replace(/[^a-z0-9-_]/g, "-")
        .replace(/-+/g, "-")
        .slice(0, 90);

      const guild = interaction.guild;
      if (!guild) return;

      const targetMember = await guild.members.fetch(userId).catch(() => null);
      if (!targetMember) {
        return interaction.reply({
          content: "‚ùå User ID nicht gefunden. Bitte pr√ºfe die Discord User ID.",
          ephemeral: true,
        });
      }

      const channel = await guild.channels.create({
        name: safeName,
        type: ChannelType.GuildText,
        parent: TICKET_CATEGORY_ID || null,
        permissionOverwrites: [
          {
            id: guild.roles.everyone.id,
            deny: [PermissionsBitField.Flags.ViewChannel],
          },
          {
            id: STAFF_ROLE_ID,
            allow: [
              PermissionsBitField.Flags.ViewChannel,
              PermissionsBitField.Flags.SendMessages,
              PermissionsBitField.Flags.ReadMessageHistory,
              PermissionsBitField.Flags.AttachFiles,
            ],
          },
          {
            id: targetMember.id,
            allow: [
              PermissionsBitField.Flags.ViewChannel,
              PermissionsBitField.Flags.SendMessages,
              PermissionsBitField.Flags.ReadMessageHistory,
              PermissionsBitField.Flags.AttachFiles,
            ],
          },
        ],
      });

      const embed = new EmbedBuilder()
        .setTitle("üßæ Neue Anfrage")
        .addFields(
          { name: "Discord User", value: `<@${targetMember.id}> (${targetMember.id})`, inline: false },
          { name: "Telefon", value: phone, inline: true },
          { name: "E-Mail", value: email, inline: true },
          { name: "Name | Ingame | Ingame ID", value: nameIngame, inline: false }
        )
        .setFooter({ text: "Bilder bitte hier im Channel als Upload oder Link posten." })
        .setTimestamp();

      await channel.send({
        content: `<@${targetMember.id}> <@&${STAFF_ROLE_ID}>`,
        embeds: [embed],
      });

      return interaction.reply({
        content: `‚úÖ Channel erstellt: <#${channel.id}>`,
        ephemeral: true,
      });
    }
  } catch (err) {
    console.error(err);
    if (interaction.isRepliable()) {
      try {
        await interaction.reply({ content: "‚ùå Fehler im Bot. Schau in die Logs (Railway).", ephemeral: true });
      } catch {}
    }
  }
});

client.login(TOKEN);
